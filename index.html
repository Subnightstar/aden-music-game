<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>王愛蹲音樂小遊戲 - 性能飆升版</title>
    <style>
        * {
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            box-sizing: border-box;
        }
        
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; overflow: hidden; position: fixed;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        #game-wrapper { 
            position: relative; width: 100vw; height: 100vh; 
            max-width: 500px; margin: 0 auto; 
            background: #000; overflow: hidden;
            /* 強制硬體加速 */
            transform: translateZ(0); 
        }
        
        canvas { 
            width: 100%; height: 100%; display: block; 
            image-rendering: optimizeSpeed; /* 針對效能優化渲染 */
        }

        .screen { 
            position: absolute; inset: 0; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 100; text-align: center; 
            background: rgba(0,0,0,0.9); padding: 20px;
            backdrop-filter: blur(5px); /* 增加點高級感 */
        }

        #score-display { 
            position: absolute; top: 15%; width: 100%; 
            text-align: center; font-size: 80px; font-weight: 900;
            color: rgba(255, 255, 255, 0.15); pointer-events: none; z-index: 1; 
        }

        #timer-display { 
            position: absolute; top: 10px; right: 15px; 
            font-size: 20px; color: #00f2ff; font-family: monospace;
            z-index: 5; text-shadow: 0 0 5px #000;
        }
        
        /* 輸入控制項優化 */
        .settings-container { 
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 20px; 
            width: 100%; border: 1px solid rgba(0, 242, 255, 0.2); 
        }
        input, select { 
            background: #111; border: 1px solid #00f2ff; color: #fff; 
            border-radius: 10px; padding: 12px; font-size: 16px; /* 防止 iOS 自動放大 */
        }
        .btn { 
            padding: 15px 40px; background: #00f2ff; border: none; 
            color: #000; cursor: pointer; font-size: 20px; font-weight: bold; 
            margin-top: 15px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 242, 255, 0.3);
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="score-display">0</div>
    <div id="timer-display">00</div>
    <canvas id="gameCanvas"></canvas>

    <div id="login-screen" class="screen">
        <h1 style="color:#00f2ff; letter-spacing: 2px;">王愛蹲</h1>
        <div class="settings-container">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="user-name-input" placeholder="玩家名" style="flex:1">
                <input type="password" id="user-pass-input" placeholder="密碼" style="flex:1">
            </div>
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <select id="game-mode" onchange="toggleTimeInput()" style="width:60%">
                    <option value="normal">普通模式</option>
                    <option value="survival">生存挑戰 (100下)</option>
                </select>
                <input type="number" id="game-time-input" value="20" style="width:35%">
            </div>
        </div>
        <button class="btn" id="start-game-btn" onclick="checkUserAndStart()">開始挑戰</button>
        <button style="background:none; border:none; color:#aaa; margin-top:20px; text-decoration: underline;" onclick="window.openRank()">查看排行榜</button>
    </div>

    <div id="fail-screen" class="screen" style="display:none">
        <h1 id="status-title" style="font-size:40px"></h1>
        <p id="final-desc" style="font-size:24px; color:#00f2ff"></p>
        <button class="btn" onclick="startGame()">再試一次</button>
        <button class="btn" style="background:#333; color:#fff; margin-top:10px;" onclick="location.reload()">回選單</button>
    </div>
</div>

<audio id="bg-music" src="background.mp3" loop preload="auto"></audio>

<script type="module">
    // Firebase 配置保持不變...
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, doc, query, where, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBbMeohY-32CbbaQQSV1HrDoIzWtNl_no4",
        authDomain: "aden-73096.firebaseapp.com",
        projectId: "aden-73096",
        storageBucket: "aden-73096.firebasestorage.app",
        messagingSenderId: "242589007552",
        appId: "1:242589007552:web:471da107803d6da9f9f725"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.verifyUserCloud = async (name, pass) => {
        try {
            const q = query(collection(db, "leaderboard"), where("name", "==", name));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return { status: "new" }; 
            const userDoc = snapshot.docs[0].data();
            return (userDoc.password === pass) ? { status: "ok", best: userDoc.score } : { status: "wrong" };
        } catch (e) { return { status: "error" }; }
    };

    window.saveScoreToCloud = async (name, pass, newScore) => {
        try {
            const q = query(collection(db, "leaderboard"), where("name", "==", name));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                const userDoc = snapshot.docs[0];
                if (userDoc.data().password === pass && newScore > userDoc.data().score) {
                    await updateDoc(doc(db, "leaderboard", userDoc.id), { score: newScore, timestamp: serverTimestamp() });
                }
            } else {
                await addDoc(collection(db, "leaderboard"), { name, password: pass, score: newScore, timestamp: serverTimestamp() });
            }
        } catch (e) {}
    };
</script>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { alpha: false }); // 關閉 alpha 通道提升效能
    const bgMusic = document.getElementById('bg-music');
    
    let audioCtx = null, hitBuffer = null;
    let score = 0, isPlaying = false, timeLeft = 0, gameTimer = null;
    let currentName = "", currentPass = "", currentVol = 0.3;
    let zombieQueue = [], visualScore = 0, spawnedCount = 0;
    
    const zombieImg = new Image(); 
    zombieImg.src = 'zombie.png';
    let imageLoaded = false; 
    zombieImg.onload = () => imageLoaded = true;

    // 螢幕尺寸快取，減少重複計算
    let W, H, laneW, rowH, finishLineY;

    function resize() {
        const dpr = Math.min(window.devicePixelRatio, 2); // 限制 DPR 最高為 2，防止高解析手機卡頓
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        
        W = rect.width;
        H = rect.height;
        laneW = W / 4;
        rowH = H * 0.13;
        finishLineY = H * 0.75;
    }
    window.addEventListener('resize', resize);
    resize();

    async function initAudio() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        try {
            const resp = await fetch('music.mp3');
            hitBuffer = await audioCtx.decodeAudioData(await resp.arrayBuffer());
        } catch (e) {}
    }

    function playHitSound() {
        if (!audioCtx || !hitBuffer) return;
        const source = audioCtx.createBufferSource();
        source.buffer = hitBuffer;
        const gain = audioCtx.createGain();
        gain.gain.value = currentVol;
        source.connect(gain).connect(audioCtx.destination);
        source.start(0);
    }

    async function checkUserAndStart() {
        const name = document.getElementById('user-name-input').value.trim();
        const pass = document.getElementById('user-pass-input').value.trim();
        if (!name || !pass) return alert("請輸入資訊");
        
        const btn = document.getElementById('start-game-btn');
        btn.innerText = "驗證中..."; btn.disabled = true;

        await initAudio();
        const result = await window.verifyUserCloud(name, pass);
        
        if (result.status === "wrong") {
            alert("密碼錯誤");
            btn.innerText = "開始挑戰"; btn.disabled = false;
            return;
        }

        currentName = name; currentPass = pass;
        document.getElementById('login-screen').style.display = 'none';
        startGame();
    }

    function startGame() {
        bgMusic.play().catch(()=>{});
        document.getElementById('fail-screen').style.display = 'none';
        score = 0; visualScore = 0; spawnedCount = 0;
        
        const mode = document.getElementById('game-mode').value;
        timeLeft = (mode === 'survival') ? 999 : parseInt(document.getElementById('game-time-input').value);
        
        zombieQueue = Array.from({length:15}, () => ({ lane: Math.floor(Math.random()*4), id: spawnedCount++ }));
        
        isPlaying = true;
        updateTimerDisplay();
        if(gameTimer) clearInterval(gameTimer);
        gameTimer = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            if(timeLeft <= 0) endGame();
        }, 1000);
        
        requestAnimationFrame(renderLoop);
    }

    function updateTimerDisplay() {
        document.getElementById('timer-display').innerText = timeLeft;
    }

    function renderLoop() {
        if (!isPlaying) return;

        // 平滑滾動數值計算
        visualScore += (score - visualScore) * 0.2;

        // 繪製背景
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, W, H);

        // 繪製判定線
        ctx.strokeStyle = "#00f2ff";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(0, finishLineY + 20);
        ctx.lineTo(W, finishLineY + 20);
        ctx.stroke();

        // 繪製殭屍 (倒序繪製，確保前面的在上面)
        for (let i = zombieQueue.length - 1; i >= 0; i--) {
            const zom = zombieQueue[i];
            const drawY = finishLineY - (zom.id - visualScore) * rowH;
            
            if (drawY > H + 100) continue; // 超出螢幕下方的移除感官
            
            const size = laneW * 0.8;
            const drawX = zom.lane * laneW + (laneW - size) / 2;

            if (imageLoaded) {
                ctx.drawImage(zombieImg, drawX, drawY, size, size);
            } else {
                ctx.fillStyle = "#00f2ff";
                ctx.fillRect(drawX, drawY, size, size);
            }
        }

        requestAnimationFrame(renderLoop);
    }

    function handleInput(lane) {
        if (!isPlaying) return;
        if (lane === zombieQueue[0].lane) {
            score++;
            document.getElementById('score-display').innerText = score;
            playHitSound(); 
            zombieQueue.shift();
            zombieQueue.push({ lane: Math.floor(Math.random() * 4), id: spawnedCount++ });
            if (score >= 100 && document.getElementById('game-mode').value === 'survival') endGame();
        } else { 
            endGame(); 
        }
    }

    // 使用 PointerEvents 解決點擊延遲
    canvas.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const lane = Math.floor((x / rect.width) * 4);
        handleInput(lane);
    }, { passive: false });

    async function endGame() {
        if (!isPlaying) return;
        isPlaying = false;
        clearInterval(gameTimer);
        bgMusic.pause();
        
        document.getElementById('status-title').innerText = "挑戰結束";
        document.getElementById('final-desc').innerText = `分數: ${score}`;
        document.getElementById('fail-screen').style.display = 'flex';

        if (document.getElementById('game-mode').value === 'survival') {
            await window.saveScoreToCloud(currentName, currentPass, score);
        }
    }

    function toggleTimeInput() { 
        document.getElementById('game-time-input').disabled = (document.getElementById('game-mode').value === 'survival'); 
    }
</script>
</body>
</html>
